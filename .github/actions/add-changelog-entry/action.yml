# ==============================================================================
# Whenever there is a new PR, add a small description of it to the CHANGELOG.md file
#
# 1. Add date
# 2. If date already exist, it should not duplicate it, append the content to the already defined date
# 3. Add the associated PR. It will use action context to get the PR
# 4. If PR already exist, then it should exit as it was already added before
# 5. Read the PR title and add that as the changelog entry explanation
# ==============================================================================

name: changelog-update
description: this check finds the unencrypted secrets in the code
inputs:
  environment:
    description: The environment in which this new PR is making a modification
    default: dev
  changelog_path:
    description: The path of the CHANGELOG file
    default: CHANGELOG.md
  changelog_create_if_missing:
    description: Create a new CHANGELOG file if it does not exist
    default: "enabled"
  run_in_base_branch:
    description: If true, Changelog file will be modified in base branch of PR. (Instead of default head branch)
    default: 'true'
  RENOVATEBOT_APP_ID:
    description: Github App ID
    default: ""
  RENOVATEBOT_APP_PRIVATE_KEY:
    description: Github App Private key
    default: ""

runs:
  using: composite
  steps:
    - name: Check that Renovate creds are set if `run_in_base_branch` is true
      shell: bash
      if: inputs.run_in_base_branch == 'true' && (inputs.RENOVATEBOT_APP_ID == '' || inputs.RENOVATEBOT_APP_PRIVATE_KEY == '')
      run: |
        echo "Error: RENOVATEBOT_APP_ID and RENOVATEBOT_APP_PRIVATE_KEY must be set when run_in_base_branch is true."
        exit 1
    - uses: actions/create-github-app-token@v1
      if: inputs.run_in_base_branch == 'true'
      id: app-token
      with:
        app-id: ${{ inputs.RENOVATEBOT_APP_ID }}
        private-key: ${{ inputs.RENOVATEBOT_APP_PRIVATE_KEY }}
    - uses: actions/checkout@v4
      with:
        ref: ${{ (inputs.run_in_base_branch == 'true' && github.base_ref) || github.head_ref }}
        token: ${{ steps.app-token.outputs.token || github.token }}
    - name: add changelog entry
      env:
        repository: ${{ github.repository }}
        pr_number: ${{ github.event.pull_request.number }}
        pr_title: ${{ github.event.pull_request.title }}
      shell: bash
      run: |
        python3 ${{ github.action_path }}/scripts/changelog.py --repository '${{ env.repository }}' --pr-number ${{ env.pr_number }} --pr-title "${{ env.pr_title }}" --environment "${{ inputs.environment }}" --changelog-path ${{ inputs.changelog_path }} --create-if-missing ${{ inputs.changelog_create_if_missing }}
        cat CHANGELOG.md
    - name: commit and push
      shell: bash
      run: |
        git add CHANGELOG.md
        git config user.name 'saritasa-renovatebot[bot]'
        git config user.email 'saritasa-renovatebot[bot]@users.noreply.github.com'
        git commit -m "feat: update CHANGELOG"
        git push
